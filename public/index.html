<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Artplayer 同步播放</title>
  <link href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.min.css" rel="stylesheet" />
  <style>
    body { margin:0; display:flex; height:100vh; font-family: Arial, sans-serif;}
    #player { flex: 2; }
    #sidebar { flex: 1; background:#f0f0f0; display:flex; flex-direction: column;}
    #chat { flex: 1; overflow-y:auto; padding:10px; border-top:1px solid #ccc;}
    #chat input { width: 80%; padding:5px; }
    #chat button { width: 18%; padding:5px; }
    #usersCount, #hostControls { padding:10px; background:#ddd; }
  </style>
</head>
<body>

<div id="player"></div>

<div id="sidebar">
  <div id="usersCount">在线人数: 0</div>
  <div id="hostControls" style="display:none;">
    <button id="btnPlay">播放</button>
    <button id="btnPause">暂停</button>
    <input type="number" id="seekInput" min="0" step="1" placeholder="跳转秒数" />
    <button id="btnSeek">跳转</button>
  </div>
  <div id="chat">
    <div id="chatMessages"></div>
    <input id="chatInput" placeholder="输入消息..." />
    <button id="btnSend">发送</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer@5.2.3/dist/artplayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer/dist/libass.min.js"></script>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get('room') || 'default-room';
  const isHost = urlParams.get('host') === '1';

  const socket = io();

  // 自定义视频和字幕地址，改成你自己的直链即可
  const videoUrl = urlParams.get('video') || 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
  const subtitleUrl = urlParams.get('subtitle') || 'https://raw.githubusercontent.com/Arnavion/libjass/master/demo/sample.ass';

  const player = new Artplayer({
    container: '#player',
    url: videoUrl,
    autoplay: false,
    muted: false,
    playsInline: true,
    subtitle: {
      url: subtitleUrl,
      encoding: 'utf-8',
      type: 'ass'
    }
  });

  socket.emit('joinRoom', {roomId, host: isHost});

  const usersCountEl = document.getElementById('usersCount');
  const hostControls = document.getElementById('hostControls');
  const btnPlay = document.getElementById('btnPlay');
  const btnPause = document.getElementById('btnPause');
  const seekInput = document.getElementById('seekInput');
  const btnSeek = document.getElementById('btnSeek');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const btnSend = document.getElementById('btnSend');

  if (isHost) hostControls.style.display = 'block';

  btnPlay.onclick = () => {
    player.play();
    socket.emit('playbackAction', {roomId, action: 'play', currentTime: player.currentTime});
  };

  btnPause.onclick = () => {
    player.pause();
    socket.emit('playbackAction', {roomId, action: 'pause', currentTime: player.currentTime});
  };

  btnSeek.onclick = () => {
    const t = parseFloat(seekInput.value);
    if (!isNaN(t) && t >= 0) {
      player.currentTime = t;
      socket.emit('playbackAction', {roomId, action: 'seek', currentTime: t});
    }
  };

  player.on('play', () => {
    if (!isHost) return;
    socket.emit('playbackAction', {roomId, action: 'play', currentTime: player.currentTime});
  });

  player.on('pause', () => {
    if (!isHost) return;
    socket.emit('playbackAction', {roomId, action: 'pause', currentTime: player.currentTime});
  });

  player.on('seeked', () => {
    if (!isHost) return;
    socket.emit('playbackAction', {roomId, action: 'seek', currentTime: player.currentTime});
  });

  socket.on('syncAction', ({action, currentTime}) => {
    if (isHost) return;
    if (action === 'play') {
      player.currentTime = currentTime;
      player.play();
    } else if (action === 'pause') {
      player.currentTime = currentTime;
      player.pause();
    } else if (action === 'seek') {
      player.currentTime = currentTime;
    }
  });

  socket.on('syncState', state => {
    if (isHost) return;
    if (!state.paused) {
      player.currentTime = state.time;
      player.play();
    } else {
      player.currentTime = state.time;
      player.pause();
    }
  });

  socket.on('userCount', count => {
    usersCountEl.textContent = '在线人数: ' + count;
  });

  socket.on('chatMessage', ({user, message}) => {
    const div = document.createElement('div');
    div.textContent = user + ': ' + message;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  btnSend.onclick = () => {
    const msg = chatInput.value.trim();
    if (msg === '') return;
    socket.emit('sendMessage', {roomId, user: isHost ? '主持人' : '观众', message: msg});
    chatInput.value = '';
  };
</script>

</body>
</html>
