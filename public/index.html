<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ArtPlayer å¤šäººåŒæ­¥æ’­æ”¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/artplayer@5.2.3/dist/artplayer.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #121212; color: #fff; }
    #login { display: flex; flex-direction: column; align-items: center; padding: 2rem; }
    #main { display: none; padding: 1rem; }
    #player { width: 100%; height: 60vh; margin-bottom: 1rem; background: black; }
    #chat { max-height: 30vh; overflow-y: auto; border: 1px solid #555; padding: 0.5rem; margin-top: 1rem; }
    #chat-input { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
    #host-panel { display: none; margin-top: 1rem; }
    input, button {
      padding: 0.5rem; margin: 0.3rem 0; width: 100%; max-width: 300px;
      background: #222; color: white; border: 1px solid #444; border-radius: 3px;
    }
    button:hover {
      background: #444;
      cursor: pointer;
    }
    .message { margin-bottom: 0.3rem; }
    .system { color: #999; font-style: italic; }
    .chat-msg { padding: 0.2rem 0; border-bottom: 1px solid #333; }
  </style>
</head>
<body>

<div id="login">
  <h2>æ™®é€šç”¨æˆ·åŠ å…¥</h2>
  <input type="text" id="username" placeholder="ç”¨æˆ·å" autocomplete="off" />
  <input type="text" id="room" placeholder="æˆ¿é—´å" autocomplete="off" />
  <input type="password" id="watchPassword" placeholder="è§‚çœ‹å¯†ç " autocomplete="off" />
  <button id="joinBtn">è¿›å…¥æˆ¿é—´</button>

  <hr style="width: 300px; margin: 2rem 0;" />
  <h2>ä¸»æŒäººç™»å½•æˆ–é¦–æ¬¡åˆ›å»ºæˆ¿é—´</h2>
  <input type="text" id="hostUsername" placeholder="ä¸»æŒäººç”¨æˆ·å" autocomplete="off" />
  <input type="text" id="hostRoom" placeholder="æˆ¿é—´å" autocomplete="off" />
  <input type="password" id="hostPassword" placeholder="ä¸»æŒäººå¯†ç " autocomplete="off" />
  <input type="password" id="setWatchPassword" placeholder="è®¾ç½®è§‚çœ‹å¯†ç " autocomplete="off" />
  <button id="hostLoginBtn">ç™»å½•/åˆ›å»ºæˆ¿é—´</button>

  <div id="loginMsg" style="color: #f44; margin-top: 1rem;"></div>
</div>

<div id="main">
  <div id="player"></div>

  <div id="host-panel">
    <h3>ğŸ› ä¸»æŒäººæ§åˆ¶é¢æ¿</h3>
    <input type="text" id="videoUrl" placeholder="è§†é¢‘é“¾æ¥ (æ”¯æŒç›´é“¾)" autocomplete="off" />
    <input type="text" id="subtitleUrl" placeholder="å­—å¹•é“¾æ¥ (.ass)" autocomplete="off" />
    <button id="sendVideo">æ·»åŠ è§†é¢‘</button>
    <button id="sendSubtitle">æ·»åŠ å­—å¹•</button>
    <button id="playBtn">æ’­æ”¾</button>
    <button id="pauseBtn">æš‚åœ</button>

    <hr />
    <h4>ä¿®æ”¹å¯†ç </h4>
    <input type="password" id="newHostPassword" placeholder="æ–°ä¸»æŒäººå¯†ç " autocomplete="off" />
    <input type="password" id="newWatchPassword" placeholder="æ–°è§‚çœ‹å¯†ç " autocomplete="off" />
    <button id="changePasswordsBtn">ä¿®æ”¹å¯†ç </button>

    <div id="changePwdMsg" style="color: #4f4; margin-top: 0.5rem;"></div>
  </div>

  <div id="chat"></div>
  <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯å›è½¦å‘é€" autocomplete="off" />
</div>

<script>
  const socket = io();

  let artplayer = null;
  let isHost = false;

  // ç™»å½•å’ŒåŠ å…¥æˆ¿é—´å…ƒç´ 
  const loginDiv = document.getElementById('login');
  const mainDiv = document.getElementById('main');
  const hostPanel = document.getElementById('host-panel');
  const loginMsg = document.getElementById('loginMsg');
  const changePwdMsg = document.getElementById('changePwdMsg');

  // æ™®é€šç”¨æˆ·åŠ å…¥
  document.getElementById('joinBtn').onclick = () => {
    const username = document.getElementById('username').value.trim();
    const room = document.getElementById('room').value.trim();
    const watchPassword = document.getElementById('watchPassword').value.trim();

    if (!username || !room || !watchPassword) {
      loginMsg.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åã€æˆ¿é—´åå’Œè§‚çœ‹å¯†ç ';
      return;
    }
    loginMsg.textContent = '';

    socket.emit('joinRoom', { room, username, watchPassword }, (res) => {
      if (res.success) {
        isHost = false;
        loginDiv.style.display = 'none';
        mainDiv.style.display = 'block';
        hostPanel.style.display = 'none';
        initPlayer();
        appendChatMessage('ç³»ç»Ÿ', `æ¬¢è¿ ${username} åŠ å…¥æˆ¿é—´ ${room}`);
      } else {
        loginMsg.textContent = res.message || 'åŠ å…¥å¤±è´¥';
      }
    });
  };

  // ä¸»æŒäººç™»å½•æˆ–é¦–æ¬¡åˆ›å»ºæˆ¿é—´
  document.getElementById('hostLoginBtn').onclick = () => {
    const username = document.getElementById('hostUsername').value.trim() || 'ä¸»æŒäºº';
    const room = document.getElementById('hostRoom').value.trim();
    const hostPassword = document.getElementById('hostPassword').value.trim();
    const watchPassword = document.getElementById('setWatchPassword').value.trim();

    if (!room || !hostPassword || !watchPassword) {
      loginMsg.textContent = 'è¯·è¾“å…¥æˆ¿é—´åã€ä¸»æŒäººå¯†ç å’Œè§‚çœ‹å¯†ç ';
      return;
    }
    loginMsg.textContent = '';

    socket.emit('hostLogin', { room, hostPassword, watchPassword, username }, (res) => {
      if (res.success) {
        isHost = true;
        loginDiv.style.display = 'none';
        mainDiv.style.display = 'block';
        hostPanel.style.display = 'block';
        initPlayer();
        appendChatMessage('ç³»ç»Ÿ', `ä¸»æŒäºº ${username} ç™»å½•æˆåŠŸï¼Œæˆ¿é—´ ${room} å·²å‡†å¤‡`);
      } else {
        loginMsg.textContent = res.message || 'ä¸»æŒäººç™»å½•å¤±è´¥';
      }
    });
  };

  // åˆå§‹åŒ–Artplayer
  function initPlayer() {
    if (artplayer) {
      artplayer.destroy();
      artplayer = null;
    }
    artplayer = new Artplayer({
      container: '#player',
      autoplay: false,
      autoSize: true,
      theme: '#00bcd4',
      controls: true,
      url: '',
      subtitle: {
        url: '',
        type: 'webvtt', // æ ¹æ®ä½ å®é™…å­—å¹•æ ¼å¼è°ƒæ•´
      },
    });

    // ä¸»æŒäººæ“ä½œåŒæ­¥
    if (isHost) {
      artplayer.on('play', () => {
        socket.emit('hostControl', { playing: true, currentTime: artplayer.currentTime });
      });
      artplayer.on('pause', () => {
        socket.emit('hostControl', { playing: false, currentTime: artplayer.currentTime });
      });
      artplayer.on('seeked', () => {
        socket.emit('hostControl', { playing: !artplayer.paused, currentTime: artplayer.currentTime });
      });
    }
  }

  // ä¸»æŒäººæ·»åŠ è§†é¢‘
  document.getElementById('sendVideo').onclick = () => {
    if (!isHost) return;
    const url = document.getElementById('videoUrl').value.trim();
    if (!url) return alert('è¯·è¾“å…¥è§†é¢‘é“¾æ¥');
    socket.emit('hostAddVideo', url);
  };

  // ä¸»æŒäººæ·»åŠ å­—å¹•
  document.getElementById('sendSubtitle').onclick = () => {
    if (!isHost) return;
    const url = document.getElementById('subtitleUrl').value.trim();
    if (!url) return alert('è¯·è¾“å…¥å­—å¹•é“¾æ¥');
    socket.emit('hostAddSubtitle', url);
  };

  // ä¸»æŒäººæ’­æ”¾æŒ‰é’®
  document.getElementById('playBtn').onclick = () => {
    if (!isHost) return;
    artplayer.play();
    socket.emit('hostControl', { playing: true, currentTime: artplayer.currentTime });
  };

  // ä¸»æŒäººæš‚åœæŒ‰é’®
  document.getElementById('pauseBtn').onclick = () => {
    if (!isHost) return;
    artplayer.pause();
    socket.emit('hostControl', { playing: false, currentTime: artplayer.currentTime });
  };

  // ä¿®æ”¹å¯†ç 
  document.getElementById('changePasswordsBtn').onclick = () => {
    if (!isHost) return;
    const newHostPassword = document.getElementById('newHostPassword').value.trim();
    const newWatchPassword = document.getElementById('newWatchPassword').value.trim();
    if (!newHostPassword && !newWatchPassword) {
      changePwdMsg.style.color = '#f44';
      changePwdMsg.textContent = 'è¯·è¾“å…¥æ–°çš„å¯†ç ';
      return;
    }
    socket.emit('hostChangePasswords', { newHostPassword, newWatchPassword }, (res) => {
      if (res.success) {
        changePwdMsg.style.color = '#4f4';
        changePwdMsg.textContent = 'å¯†ç ä¿®æ”¹æˆåŠŸ';
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('newHostPassword').value = '';
        document.getElementById('newWatchPassword').value = '';
      } else {
        changePwdMsg.style.color = '#f44';
        changePwdMsg.textContent = res.message || 'å¯†ç ä¿®æ”¹å¤±è´¥';
      }
    });
  };

  // èŠå¤©åŠŸèƒ½
  const chatDiv = document.getElementById('chat');
  const chatInput = document.getElementById('chat-input');

  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const msg = chatInput.value.trim();
      if (msg) {
        socket.emit('chatMessage', msg);
        chatInput.value = '';
      }
    }
  });

  // æ”¶åˆ°èŠå¤©æ¶ˆæ¯
  socket.on('chatMessage', (data) => {
    appendChatMessage(data.id, data.msg);
  });

  // æ”¶åˆ°è§†é¢‘æ›´æ–°
  socket.on('videoUpdate', ({ videoUrl, subtitleUrl }) => {
    if (!artplayer) return;
    if (videoUrl) artplayer.url = videoUrl;
    if (subtitleUrl) artplayer.subtitle.url = subtitleUrl;
  });

  // æ”¶åˆ°è§†é¢‘çŠ¶æ€åŒæ­¥
  socket.on('videoState', (state) => {
    if (!artplayer) return;
    // é¿å…é‡å¤è·³è½¬
    const currentDiff = Math.abs(artplayer.currentTime - state.currentTime);
    if (currentDiff > 0.5) {
      artplayer.currentTime = state.currentTime;
    }
    if (state.playing) {
      artplayer.play();
    } else {
      artplayer.pause();
    }
  });

  // ä¸»æŒäººèº«ä»½ç¡®è®¤
  socket.on('hostAssigned', () => {
    isHost = true;
    hostPanel.style.display = 'block';
  });

  // è¾…åŠ©å‡½æ•°
  function appendChatMessage(id, msg) {
    const el = document.createElement('div');
    el.classList.add('chat-msg');
    if (id === 'ç³»ç»Ÿ') {
      el.classList.add('system');
      el.textContent = `ã€${id}ã€‘ ${msg}`;
    } else {
      el.textContent = `${id}: ${msg}`;
    }
    chatDiv.appendChild(el);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }
</script>

</body>
</html>
